@model List<MovieTheater.Web.Areas.Booking.Models.Seat>
@{
    ViewData["SidebarActive"] = "RoomManagement";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Quản lý ghế - Phòng " + ViewBag.RoomName;
    var groupedSeats = Model
        .GroupBy(s => s.SeatRow)
        .OrderBy(g => g.Key);
    var maxColumns = Model.Max(s => s.SeatColumn);
}


<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f0fe 0%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

            .header h1 {
                color: #333;
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 10px;
                text-transform: uppercase;
                letter-spacing: 2px;
            }

        .room-info {
            background: linear-gradient(135deg, #a5b4fc, #c4b5fd);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            display: inline-block;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .screen {
            background: linear-gradient(to bottom, #a5b4fc 0%, #c4b5fd 100%);
            height: 80px;
            width: 90%;
            margin: 0 auto 50px;
            border-radius: 15px 15px 50% 50% / 15px 15px 100% 100%;
            box-shadow: 0 10px 30px rgba(165, 180, 252, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: 800;
            letter-spacing: 8px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

            .screen::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                animation: screenShine 5s infinite;
            }

        @@keyframes screenShine {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            color: #4a5568;
            font-weight: 600;
        }

        .legend-seat {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            border: 2px solid;
        }

        .seat-map {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .seat-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            min-width: fit-content;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
            align-items: center;
        }

        .row-label {
            width: 40px;
            text-align: center;
            font-size: 16px;
            color: #64748b;
            margin-right: 25px;
            font-weight: 700;
        }

        .seat {
            width: 40px;
            height: 40px;
            margin: 0 6px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            border: 2px solid rgba(102, 126, 234, 0.2);
            animation: seatAppear 0.4s ease-out forwards;
            animation-fill-mode: both;
        }

            .seat.available {
                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                color: #64748b;
                border-color: rgba(100, 116, 139, 0.2);
            }

                .seat.available:hover {
                    transform: scale(1.2) translateY(-4px);
                    border-color: #64748b;
                    background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
                    box-shadow: 0 12px 30px rgba(100, 116, 139, 0.2);
                }

            .seat.unavailable {
                background: linear-gradient(135deg, #fef2f2, #fee2e2);
                border-color: #fca5a5;
                cursor: not-allowed;
                opacity: 0.8;
                color: #dc2626;
            }

                .seat.unavailable::after {
                    content: '×';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: #dc2626;
                    font-size: 20px;
                    font-weight: bold;
                }

                .seat.unavailable:hover {
                    transform: scale(1.2) translateY(-4px);
                    background: linear-gradient(135deg, #fee2e2, #fecaca);
                    box-shadow: 0 12px 30px rgba(248, 113, 113, 0.2);
                }

            .seat.selected {
                background: linear-gradient(135deg, #a5b4fc, #c4b5fd);
                border-color: transparent;
                transform: scale(1.15);
                box-shadow: 0 10px 30px rgba(165, 180, 252, 0.3);
                color: white;
            }

                .seat.selected::after {
                    content: '✓';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-size: 18px;
                    font-weight: bold;
                }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            color: #475569;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(100, 116, 139, 0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #a5b4fc, #c4b5fd);
            color: white;
            box-shadow: 0 5px 15px rgba(165, 180, 252, 0.2);
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(165, 180, 252, 0.3);
            }

        .btn-success {
            background: linear-gradient(135deg, #86efac, #6ee7b7);
            color: white;
            box-shadow: 0 5px 15px rgba(134, 239, 172, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fca5a5, #f87171);
            color: white;
            box-shadow: 0 5px 15px rgba(252, 165, 165, 0.2);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

            .toast.show {
                transform: translateX(0);
            }

        @@media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .seat {
                width: 35px;
                height: 35px;
                font-size: 10px;
            }

            .legend {
                gap: 15px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animation cho ghế - Chỉ chạy 1 lần khi load */
        @@keyframes seatAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0px);
            }
        }

        .seat {
            animation: seatAppear 0.4s ease-out forwards;
            animation-fill-mode: both;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>QUẢN LÝ GHẾ</h1>
            <div class="room-info">
                Phòng @(ViewBag.RoomName ?? ViewBag.RoomId) - Tổng cộng @(Model?.Count ?? 0) ghế
            </div>

            <!-- DEBUG INFO -->
            @* @if (Model == null)
            {
                <div style="background: red; color: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ⚠️ Model is NULL!
                </div>
            }
            else if (!Model.Any())
            {
                <div style="background: orange; color: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ⚠️ Model is EMPTY! Count: @Model.Count
                </div>
            }
            else
            {
                <div style="background: green; color: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ✅ Model has @Model.Count seats. Groups: @(Model.GroupBy(s => s.SeatRow).Count())
                </div>
            } *@
        </div>

        <div class="screen">MÀN HÌNH</div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-seat" style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-color: rgba(100, 116, 139, 0.2); color: #64748b;">A1</div>
                <span>Ghế hoạt động</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat" style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border-color: #fca5a5; color: #dc2626;">×</div>
                <span>Ghế hỏng</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat" style="background: linear-gradient(135deg, #a5b4fc, #c4b5fd); border-color: transparent; color: white;">✓</div>
                <span>Đang chọn (admin mode)</span>
            </div>
        </div>

        <div class="seat-map">
            @* <!-- DEBUG: Show raw data -->
            <div style="background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-family: monospace;">
                <strong>DEBUG INFO:</strong><br>
                Model Count: @(Model?.Count ?? 0)<br>
                @if (Model != null && Model.Any())
                {
                    <span>First seat: @Model.First().SeatRow@Model.First().SeatColumn (Status: @Model.First().SeatStatus)</span>
                
                    <br>
                    <span>Groups: @string.Join(", ", groupedSeats.Select(g => $"{g.Key}({g.Count()})"))</span>

                    <br>
                    <span>Max columns: @maxColumns</span>
                }
            </div> *@

            <div class="seat-grid">
                @if (Model == null || !Model.Any())
                {
                    @* <div style="text-align: center; padding: 50px; color: red; font-size: 1.2rem;">
                        ❌ Không có dữ liệu ghế!
                    </div> *@
                }
                else
                {
                    @foreach (var row in groupedSeats)
                    {
                        <div class="seat-row">
                            <div class="row-label">@row.Key</div>

                            @* Hiển thị tất cả ghế trong row, theo thứ tự column *@
                            @foreach (var seat in row.OrderBy(s => s.SeatColumn))
                            {
                                var seatClass = seat.SeatStatus ? "available" : "unavailable";
                                <div class="seat @seatClass"
                                     data-id="@seat.Id"
                                     data-row="@seat.SeatRow"
                                     data-col="@seat.SeatColumn"
                                     style="animation-delay: @((int)row.Key * 50 + seat.SeatColumn * 20)ms"
                                     onclick="toggleSeat(this)">
                                    @($"{seat.SeatRow}{seat.SeatColumn}")
                                </div>
                            }

                            @* Nếu muốn có khoảng trống giữa các cột, uncomment dòng này *@
                            @* @for (int col = 1; col <= maxColumns; col++)
                            {
                                var seat = row.FirstOrDefault(s => s.SeatColumn == col);
                                if (seat != null)
                                {
                                    var seatClass = seat.SeatStatus ? "available" : "unavailable";
                                    <div class="seat @seatClass"
                                         data-id="@seat.Id"
                                         data-row="@seat.SeatRow"
                                         data-col="@seat.SeatColumn"
                                         style="animation-delay: @((int)row.Key * 50 + col * 20)ms"
                                         onclick="toggleSeat(this)">
                                        @($"{seat.SeatRow}{seat.SeatColumn}")
                                    </div>
                                }
                                else
                                {
                                    <div class="seat" style="visibility: hidden; pointer-events: none;"></div>
                                }
                            } *@
                        </div>
                    }
                }
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="availableCount">
                    @(Model?.Count(s => s.SeatStatus) ?? 0)
                </div>
                <div class="stat-label">Ghế hoạt động</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unavailableCount">
                    @(Model?.Count(s => !s.SeatStatus) ?? 0)
                </div>
                <div class="stat-label">Ghế hỏng</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">@(Model?.Count ?? 0)</div>
                <div class="stat-label">Tổng số ghế</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">@(Model != null && Model.Any() ? Math.Round(Model.Count(s => s.SeatStatus) * 100.0 / Model.Count, 1) : 0)%</div>
                <div class="stat-label">Tỷ lệ hoạt động</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-success" onclick="enableAllSeats()">
                ✅ Kích hoạt tất cả
            </button>
            <button class="btn btn-danger" onclick="disableAllSeats()">
                ❌ Vô hiệu tất cả
            </button>
            <a href="/Booking/CinemaRoom/CinemaRooms" class="btn btn-primary">
                ← Quay lại danh sách phòng
            </a>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let selectedSeat = null;

        function toggleSeat(element) {
            const seatId = element.dataset.id;
            const row = element.dataset.row;
            const col = element.dataset.col;

            console.log(`👉 Clicked seat: ${row}${col} (ID: ${seatId})`);

            if (!seatId) {
                showToast('⚠️ Không có thông tin ghế', 'warning');
                return;
            }

            // Add loading state
            element.style.opacity = '0.6';
            element.style.pointerEvents = 'none';

            fetch(`/Booking/CinemaRoom/ToggleSeatStatus?seatId=${seatId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(async response => {
                const data = await response.json();
                console.log("📥 Server response:", data);

                if (data.success) {
                    // Toggle seat status
                    if (element.classList.contains('available')) {
                        element.classList.remove('available');
                        element.classList.add('unavailable');
                        showToast(`✅ Ghế ${row}${col} đã được đánh dấu hỏng`, 'success');
                    } else {
                        element.classList.remove('unavailable');
                        element.classList.add('available');
                        showToast(`✅ Ghế ${row}${col} đã được kích hoạt`, 'success');
                    }

                    // Update statistics
                    updateStats();

                    // Add success animation
                    element.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        element.style.transform = '';
                    }, 200);
                } else {
                    showToast(`❌ ${data.message || 'Không thể cập nhật ghế'}`, 'error');
                }
            })
            .catch(error => {
                console.error("🔥 Error:", error);
                showToast('🔥 Lỗi kết nối: ' + error.message, 'error');
            })
            .finally(() => {
                // Remove loading state
                element.style.opacity = '';
                element.style.pointerEvents = '';
            });
        }

        function enableAllSeats() {
            if (!confirm('Bạn có chắc muốn kích hoạt tất cả ghế?')) return;

            const unavailableSeats = document.querySelectorAll('.seat.unavailable');
            let processed = 0;

            unavailableSeats.forEach((seat, index) => {
                setTimeout(() => {
                    seat.click();
                    processed++;

                    if (processed === unavailableSeats.length) {
                        showToast(`✅ Đã kích hoạt ${unavailableSeats.length} ghế`, 'success');
                    }
                }, index * 100);
            });
        }

        function disableAllSeats() {
            if (!confirm('Bạn có chắc muốn vô hiệu hóa tất cả ghế?')) return;

            const availableSeats = document.querySelectorAll('.seat.available');
            let processed = 0;

            availableSeats.forEach((seat, index) => {
                setTimeout(() => {
                    seat.click();
                    processed++;

                    if (processed === availableSeats.length) {
                        showToast(`✅ Đã vô hiệu ${availableSeats.length} ghế`, 'success');
                    }
                }, index * 100);
            });
        }

        function updateStats() {
            const availableSeats = document.querySelectorAll('.seat.available').length;
            const unavailableSeats = document.querySelectorAll('.seat.unavailable').length;
            const total = availableSeats + unavailableSeats;

            document.getElementById('availableCount').textContent = availableSeats;
            document.getElementById('unavailableCount').textContent = unavailableSeats;

            // Update percentage
            const percentage = total > 0 ? Math.round(availableSeats * 100 / total * 10) / 10 : 0;
            document.querySelector('.stat-card:last-child .stat-number').textContent = percentage + '%';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;

            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📦 Admin Seat Management loaded');

            // Add stagger animation to seats
            const seats = document.querySelectorAll('.seat');
            seats.forEach((seat, index) => {
                seat.style.animationDelay = `${index * 0.02}s`;
            });

            showToast('🎭 Quản lý ghế đã sẵn sàng', 'success');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                enableAllSeats();
            } else if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                disableAllSeats();
            }
        });
    </script>
</body>
</html>