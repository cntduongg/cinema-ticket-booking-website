@using MovieTheater.Web.Areas.Booking.Models
@{
    ViewData["Title"] = "Lịch sử đặt vé";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/seatmap.css" />
<div class="container" style="margin-top: 40px;">
    <h2 class="mb-4"><i class="fas fa-history"></i> Lịch sử đặt vé</h2>
    <div id="bookingHistoryTableContainer">
        <div class="text-center text-muted">Đang tải dữ liệu...</div>
    </div>
    <nav id="paginationNav" aria-label="Page navigation" class="mt-4" style="display:none;">
        <ul class="pagination justify-content-center"></ul>
    </nav>
</div>
@section Scripts {
<script>
    async function fetchBookingHistory(page = 1) {
        const userId = localStorage.getItem('userId') || (window.realUserId || '');
        if (!userId) {
            document.getElementById('bookingHistoryTableContainer').innerHTML = '<div class="alert alert-warning">Không tìm thấy thông tin người dùng.</div>';
            return;
        }
        try {
            const res = await fetch(`/Booking/Booking/GetBookingHistory?userId=${userId}&page=${page}&pageSize=10`);
            const data = await res.json();
            renderBookingHistoryTable(data.orders);
            renderPagination(page, data.total, 10);
        } catch (e) {
            document.getElementById('bookingHistoryTableContainer').innerHTML = '<div class="alert alert-danger">Lỗi khi tải dữ liệu lịch sử đặt vé.</div>';
        }
    }
    function renderBookingHistoryTable(orders) {
        if (!orders || orders.length === 0) {
            document.getElementById('bookingHistoryTableContainer').innerHTML = '<div class="alert alert-info">Bạn chưa có lịch sử đặt vé nào.</div>';
            return;
        }
        let html = `<table class="table table-striped table-bordered text-light" style="background:rgba(0,0,0,0.3);">
            <thead class="thead-dark" style="background:#222; color:#fff;">
                <tr>
                    <th class="text-light">Mã đơn</th>
                    <th class="text-light">Ngày đặt</th>
                    <th class="text-light">Ngày chiếu</th>
                    <th class="text-light">Phòng chiếu</th>
                    <th class="text-light">Ghế</th>
                    <th class="text-light">Tổng tiền</th>
                    <th class="text-light">Trạng thái</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">`;
        for (const o of orders) {
            html += `<tr id="orderRow_${o.id}">
                <td class="text-light">${o.id}</td>
                <td class="text-light">${o.bookingDate || ''}</td>
                <td class="text-light" id="showDate_${o.id}">...</td>
                <td class="text-light" id="room_${o.id}">...</td>
                <td class="text-light" id="seats_${o.id}">...</td>
                <td class="text-light">${o.totalPrice?.toLocaleString() || 0} VND</td>
                <td>${o.status ? '<span class="badge bg-success">Đã xác nhận</span>' : '<span class="badge bg-secondary">Chưa xác nhận</span>'}</td>
            </tr>`;
        }
        html += '</tbody></table>';
        document.getElementById('bookingHistoryTableContainer').innerHTML = html;
        // Bổ sung: gọi API lấy chi tiết từng order
        orders.forEach(o => fetchAndRenderOrderExtra(o.id));
    }
    async function fetchAndRenderOrderExtra(orderId) {
        try {
            // 1. Lấy orderDetails
            const detailRes = await fetch(`https://localhost:7092/api/OrderDetail/order/${orderId}`);
            let orderDetails = await detailRes.json();
            if (orderDetails.$values) orderDetails = orderDetails.$values;
            if (!Array.isArray(orderDetails) || orderDetails.length === 0) return;
            // Lấy scheduleId từ orderDetail đầu tiên
            const scheduleId = orderDetails[0].scheduleId || orderDetails[0].ScheduleId;
            // 2. Lấy schedule
            const scheduleRes = await fetch(`https://localhost:7092/api/Schedule/${scheduleId}`);
            const scheduleData = await scheduleRes.json();
            const showDate = scheduleData.showDate || scheduleData.ShowDate;
            const cinemaRoomId = scheduleData.cinemaRoomId || scheduleData.CinemaRoomId;
            // 3. Lấy tên phòng
            let roomName = '';
            try {
                const roomRes = await fetch(`https://localhost:7092/api/CinemaRoom/${cinemaRoomId}`);
                const roomData = await roomRes.json();
                roomName = roomData.cinemaRoomName || roomData.CinemaRoomName || roomData.name || '';
            } catch {}
            // 4. Map seatId -> seatName
            const seatIds = orderDetails.map(od => od.seatId || od.SeatId);
            let seatNames = [];
            try {
                const seatRes = await fetch(`https://localhost:7092/api/Seat/by-ids?ids=${seatIds.join(',')}`);
                let seats = await seatRes.json();
                if (seats.$values) seats = seats.$values;
                if (Array.isArray(seats) && seats.length > 0) {
                    seatNames = seatIds.map(id => {
                        const seat = seats.find(s => s.id == id || s.Id == id);
                        if (seat && (seat.seatRow || seat.SeatRow) && (seat.seatColumn || seat.SeatColumn)) {
                            return (seat.seatRow || seat.SeatRow) + (seat.seatColumn || seat.SeatColumn);
                        }
                        return id;
                    });
                } else {
                    seatNames = seatIds;
                }
            } catch { seatNames = seatIds; }
            // Nếu vẫn chỉ là số, fallback lấy toàn bộ ghế phòng để map
            if (seatNames.every(name => typeof name === 'number' || /^[0-9]+$/.test(name))) {
                try {
                    const allSeatsRes = await fetch(`https://localhost:7092/api/Seat/room/${cinemaRoomId}`);
                    let allSeats = await allSeatsRes.json();
                    if (allSeats.$values) allSeats = allSeats.$values;
                    seatNames = seatIds.map(id => {
                        const seat = allSeats.find(s => s.id == id || s.Id == id);
                        if (seat && (seat.seatRow || seat.SeatRow) && (seat.seatColumn || seat.SeatColumn)) {
                            return (seat.seatRow || seat.SeatRow) + (seat.seatColumn || seat.SeatColumn);
                        }
                        return id;
                    });
                } catch {}
            }
            // Render vào bảng
            document.getElementById(`showDate_${orderId}`).innerText = showDate || '';
            document.getElementById(`room_${orderId}`).innerText = roomName || '';
            document.getElementById(`seats_${orderId}`).innerText = seatNames.join(', ');
        } catch {}
    }
    function renderPagination(currentPage, totalItems, pageSize) {
        const totalPages = Math.ceil(totalItems / pageSize);
        const nav = document.getElementById('paginationNav');
        const ul = nav.querySelector('ul');
        ul.innerHTML = '';
        if (totalPages <= 1) {
            nav.style.display = 'none';
            return;
        }
        nav.style.display = '';
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === currentPage ? ' active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.onclick = (e) => {
                e.preventDefault();
                fetchBookingHistory(i);
            };
            li.appendChild(a);
            ul.appendChild(li);
        }
    }
    document.addEventListener('DOMContentLoaded', function() { fetchBookingHistory(1); });
</script>
} 