@{
    ViewData["Title"] = "Lịch sử tích điểm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/seatmap.css" />
<div class="container" style="margin-top: 40px;">
    <h2 class="mb-4"><i class="fas fa-coins"></i> Lịch sử tích điểm</h2>
    <div id="scoreSummary" class="mb-4">
        <div><strong>Điểm đã tích lũy:</strong> <span id="scoreAccumulated">0</span> điểm</div>
        <div><strong>Điểm đã sử dụng:</strong> <span id="scoreUsed">0</span> điểm</div>
        <div><strong>Điểm hiện có:</strong> <span id="scoreCurrent">0</span> điểm</div>
    </div>
    <h5 class="mb-3">Lịch sử điểm</h5>
    <div class="mb-2 d-flex align-items-center">
        <label for="scorePageSize" class="me-2">Hiển thị</label>
        <select id="scorePageSize" class="form-select form-select-sm" style="width: 80px;">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
        </select>
        <span class="ms-2">mục</span>
        <div class="ms-auto">
            <label for="scoreSearch" class="me-2">Tìm kiếm:</label>
            <input id="scoreSearch" class="form-control form-control-sm" style="width: 180px; display:inline-block;" />
        </div>
    </div>
    <div id="scoreHistoryTableContainer">
        <div class="text-center text-muted">Đang tải dữ liệu...</div>
    </div>
    <nav id="scorePaginationNav" aria-label="Page navigation" class="mt-4" style="display:none;">
        <ul class="pagination justify-content-center"></ul>
    </nav>
</div>
@section Scripts {
    <script>
        let scoreHistoryRaw = [];
        let scorePageSize = 10;
        let scoreCurrentPage = 1;
        let scoreSearchTerm = '';
        async function fetchScoreHistory(page = 1) {
            const userId = localStorage.getItem('userId') || (window.realUserId || '');
            if (!userId) {
                document.getElementById('scoreHistoryTableContainer').innerHTML = '<div class="alert alert-warning">Không tìm thấy thông tin người dùng.</div>';
                return;
            }
            try {
                // Lấy điểm hiện có
                const scoreRes = await fetch(`https://localhost:7041/api/Score/${userId}`);
                const scoreCurrent = await scoreRes.json();
                document.getElementById('scoreCurrent').innerText = scoreCurrent;
                // Lấy lịch sử điểm
                const historyRes = await fetch(`https://localhost:7092/api/Score/history/${userId}`);
                let history = await historyRes.json();
                if (history.$values) history = history.$values;
                if (!Array.isArray(history)) history = [];
                scoreHistoryRaw = history;
                // Tính tổng tích lũy và đã sử dụng
                let accumulated = 0, used = 0;
                for (const h of history) {
                    const score = h.score || h.Score || 0;
                    if (score > 0) accumulated += score;
                    else used += Math.abs(score);
                }
                document.getElementById('scoreAccumulated').innerText = accumulated.toLocaleString('vi-VN');
                document.getElementById('scoreUsed').innerText = used.toLocaleString('vi-VN');
                renderScoreHistoryTable();
            } catch (e) {
                document.getElementById('scoreHistoryTableContainer').innerHTML = '<div class="alert alert-danger">Lỗi khi tải dữ liệu lịch sử điểm.</div>';
            }
        }
        function renderScoreHistoryTable() {
            let filtered = scoreHistoryRaw;
            if (scoreSearchTerm) {
                filtered = filtered.filter(h => {
                    const content = (h.actionType || h.ActionType || '') + ' ' + (h.note || h.Note || '') + ' ' + (h.createdAt || h.CreatedAt || '');
                    return content.toLowerCase().includes(scoreSearchTerm.toLowerCase());
                });
            }
            const total = filtered.length;
            const pageSize = scorePageSize;
            const page = scoreCurrentPage;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filtered.slice(start, end);
            let html = `<table class="table table-striped table-bordered text-light" style="background:rgba(0,0,0,0.3);">
                <thead class="thead-dark" style="background:#222; color:#fff;">
                    <tr>
                        <th>Thời gian</th>
                        <th>Số điểm</th>
                        <th>Nội dung sử dụng</th>
                    </tr>
                </thead>
                <tbody id="scoreTableBody">`;
            for (const h of pageData) {
                const createdAt = h.createdAt || h.CreatedAt || '';
                const dateStr = createdAt ? new Date(createdAt).toLocaleString('vi-VN') : '';
                const score = h.score || h.Score || 0;
                const scoreStr = (score > 0 ? '+' : '') + score.toLocaleString('vi-VN');
                const actionContent = score > 0 ? 'Tích điểm' : 'Tiêu điểm';

                html += `<tr>
                    <td style="color: #ffffff; font-weight: 500;">${dateStr}</td>
                    <td style="color: ${score > 0 ? '#4CAF50' : '#f44336'}; font-weight: 600;">${scoreStr}</td>
                        <td style="color: #ffffff; font-weight: 500;">${actionContent}</td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('scoreHistoryTableContainer').innerHTML = html;
            renderScorePagination(page, total, pageSize);
        }
        function renderScorePagination(currentPage, totalItems, pageSize) {
            const totalPages = Math.ceil(totalItems / pageSize);
            const nav = document.getElementById('scorePaginationNav');
            const ul = nav.querySelector('ul');
            ul.innerHTML = '';
            if (totalPages <= 1) {
                nav.style.display = 'none';
                return;
            }
            nav.style.display = '';
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.innerText = i;
                a.onclick = (e) => {
                    e.preventDefault();
                    scoreCurrentPage = i;
                    renderScoreHistoryTable();
                };
                li.appendChild(a);
                ul.appendChild(li);
            }
        }
        document.getElementById('scorePageSize').onchange = function() {
            scorePageSize = parseInt(this.value);
            scoreCurrentPage = 1;
            renderScoreHistoryTable();
        };
        document.getElementById('scoreSearch').oninput = function() {
            scoreSearchTerm = this.value;
            scoreCurrentPage = 1;
            renderScoreHistoryTable();
        };
        document.addEventListener('DOMContentLoaded', function() { fetchScoreHistory(1); });
    </script>
}
