@{
    ViewData["Title"] = "Xác nhận thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    ViewData["Title"] = "Xác nhận thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>@ViewData["Title"] - MovieTheater</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Copy toàn bộ phần :root và các style liên quan đến background, movie-info-header, movie-header-content, ... từ SeatMap.cshtml --- */
        :root {
            --primary-blue: #E8F4FD;
            --secondary-blue: #D1E9F6;
            --accent-blue: #B8DDFF;
            --deep-blue: #7FB8D3;
            --dark-blue: #4A90A4;
            --text-dark: #1A365D;
            --text-light: #4A5568;
            --white: #FFFFFF;
            --gray-50: #F7FAFC;
            --gray-100: #EDF2F7;
            --gray-200: #E2E8F0;
            --red-accent: #FF6B7A;
            --green-accent: #48BB78;
            --gradient-primary: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 50%, var(--deep-blue) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%);
            --gradient-header: linear-gradient(135deg, rgba(26, 54, 93, 0.95) 0%, rgba(74, 144, 164, 0.9) 100%);
            --shadow-soft: 0 4px 20px rgba(127, 184, 211, 0.15);
            --shadow-medium: 0 8px 30px rgba(127, 184, 211, 0.2);
            --shadow-strong: 0 15px 40px rgba(127, 184, 211, 0.3);
            --border-radius: 20px;
            --border-radius-small: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gradient-primary);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .movie-info-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(20px);
        }

        .movie-header-content {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2rem;
            align-items: center;
        }

        .movie-poster-3d {
            width: 120px;
            height: 160px;
            border-radius: var(--border-radius-small);
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

            .movie-poster-3d img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
            }

            .movie-poster-3d:hover img {
                transform: scale(1.05);
            }

        .movie-details {
            flex: 1;
        }

        .movie-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            .movie-title::before {
                content: '🎬';
                font-size: 1.5rem;
            }

        .movie-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--gradient-secondary);
            border-radius: var(--border-radius-small);
            transition: all 0.3s ease;
        }

            .meta-item:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-soft);
            }

            .meta-item i {
                color: var(--deep-blue);
                font-size: 1.2rem;
                width: 20px;
                text-align: center;
            }

            .meta-item strong {
                color: var(--text-dark);
                font-weight: 600;
            }

            .meta-item span {
                color: var(--text-light);
            }
        .checkout-confirm-container {
            background: rgba(255,255,255,0.97);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .checkout-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
        }
        .checkout-content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        .checkout-left {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .checkout-section {
            background: var(--gradient-secondary);
            border-radius: var(--border-radius-small);
            padding: 1.2rem 1.5rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-soft);
        }
        .voucher-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #voucherInput {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-size: 1rem;
        }
        #checkVoucherBtn {
            background: var(--deep-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        #checkVoucherBtn:hover {
            background: var(--dark-blue);
        }
        .point-table td {
            padding: 0.3rem 0.5rem;
        }
        #extraSeatSelect {
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
        }
        .checkout-right {
            background: var(--gradient-header);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow-strong);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 1.5rem;
            min-width: 280px;
        }
        .price-summary > div {
            font-size: 1.1rem;
            margin-bottom: 0.7rem;
        }
        .pay-btn {
            background: rgba(255,255,255,0.95);
            color: var(--deep-blue);
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            padding: 1rem 0;
            transition: all 0.2s;
        }
        .pay-btn:hover:not(:disabled) {
            background: white;
            color: var(--dark-blue);
            box-shadow: var(--shadow-medium);
        }
        .pay-btn:disabled {
            background: rgba(255,255,255,0.5);
            color: rgba(127,184,211,0.7);
            cursor: not-allowed;
        }
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .collapse-icon {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--deep-blue);
            margin-left: 1rem;
            transition: transform 0.2s;
        }
        .collapsible-header.open .collapse-icon {
            transform: rotate(45deg);
        }
        .collapsible-content {
            margin-top: 0.7rem;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--deep-blue);
            color: white;
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.7rem 1.5rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }

            .back-btn:hover {
                background: var(--dark-blue);
                color: #fff;
                box-shadow: var(--shadow-medium);
            }
    </style>
</head>

<body>
    <div class="container">
        <!-- Movie Info Header -->
        <div class="movie-info-header">
            <div class="movie-header-content">
                <div class="movie-poster-3d" id="moviePoster">
                    <i class="fas fa-film" style="font-size: 2rem; color: var(--deep-blue);"></i>
                </div>
                <div class="movie-details">
                    <h2 class="movie-title" id="movieTitle">Đang tải thông tin phim...</h2>
                    <div class="movie-meta-grid">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span><strong>Rạp chiếu:</strong> <span id="cinemaName">Đang tải...</span></span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span><strong>Ngày chiếu:</strong> <span id="showDate">Đang tải...</span></span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span><strong>Giờ chiếu:</strong> <span id="showTime">Đang tải...</span></span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-door-open"></i>
                            <span><strong>Phòng chiếu:</strong> <span id="roomName">Đang tải...</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Nút quay lại -->
        <button class="back-btn" onclick="goBackToSeatMap()">
            <i class="fas fa-arrow-left"></i> Quay lại chọn ghế
        </button>

        <!-- Xác nhận thanh toán -->
        <div class="checkout-confirm-container">
            <h2 class="checkout-title">Xác nhận thanh toán</h2>
            <div class="checkout-content-grid">
                <!-- Cột trái: Thông tin cá nhân, ghế đã đặt, voucher, điểm -->
                <div class="checkout-left">
                    <!-- Thông tin cá nhân -->
                    <div class="checkout-section">
                        <h3>Thông tin cá nhân</h3>
                        <div id="userInfo">
                            <div><strong>Họ tên:</strong> <span id="userName">Đang tải...</span></div>
                            <div><strong>Giới tính:</strong> <span id="userGender">Đang tải...</span></div>
                            <div><strong>SĐT:</strong> <span id="userPhone">Đang tải...</span></div>
                        </div>
                    </div>
                    <!-- Ghế đã đặt -->
                    <div class="checkout-section">
                        <h3>Ghế đã đặt (<span id="seatCount">0</span>)</h3>
                        <div id="seatList">Đang tải...</div>
                    </div>
                    <!-- Áp dụng voucher (collapsible) -->
                    <div class="checkout-section">
                        <div class="collapsible-header" onclick="toggleCollapse('voucherCollapse')">
                            <h3>Áp dụng voucher</h3>
                            <span class="collapse-icon" id="icon-voucherCollapse">+</span>
                        </div>
                        <div class="collapsible-content" id="voucherCollapse" style="display:none;">
                            <div class="voucher-row">
                                <input type="text" id="voucherInput" placeholder="Nhập mã voucher..." />
                                <button id="checkVoucherBtn">Kiểm tra</button>
                            </div>
                            <div id="voucherResult"></div>
                        </div>
                    </div>
                    <!-- Điểm thưởng (collapsible) -->
                    <div class="checkout-section">
                        <div class="collapsible-header" onclick="toggleCollapse('pointCollapse')">
                            <h3>Điểm thưởng</h3>
                            <span class="collapse-icon" id="icon-pointCollapse">+</span>
                        </div>
                        <div class="collapsible-content" id="pointCollapse" style="display:none;">
                            <table class="point-table">
                                <tr><td>Điểm hiện có:</td><td id="userPoint">0</td></tr>
                                <tr><td>Điểm muốn dùng:</td><td><input type="number" id="pointInput" min="0" value="0" /></td></tr>
                            </table>
                            <div id="pointExtraSeat" style="display:none; margin-top:8px;">
                                <label>Chọn thêm 1 ghế miễn phí:
                                    <select id="extraSeatSelect"></select>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Cột phải: Tổng tiền -->
                <div class="checkout-right">
                    <div class="price-summary">
                        <div><strong>Tổng tiền:</strong> <span id="totalPrice">0</span> VND</div>
                        <div><strong>Giảm giá:</strong> <span id="discount">0</span> VND</div>
                        <div><strong>Cần thanh toán:</strong> <span id="finalPrice">0</span> VND</div>
                    </div>
                    <button class="pay-btn" id="payBtn" >Thanh toán</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', async function() {             
                let myUserId = window.realUserId || localStorage.getItem('userId');
                if (!myUserId) {                    
                    return;
                }

                // 1. Lấy thông tin cá nhân
                try {
                    const res = await fetch(`https://localhost:7041/api/Admin/getUser/${myUserId}`);
                    const data = await res.json();
                    console.log('User API result:', data);
                    const user = data.data;
                    document.getElementById('userName').innerText = user.fullName || '';
                    document.getElementById('userGender').innerText = user.sex || '';
                    document.getElementById('userPhone').innerText = user.phoneNumber || '';
                } catch (e) {
                    document.getElementById('userName').innerText = 'Không lấy được';
                    document.getElementById('userGender').innerText = 'Không lấy được';
                    document.getElementById('userPhone').innerText = 'Không lấy được';
                }

                // 2. Lấy điểm
                try {
                    const res = await fetch(`https://localhost:7041/api/Score/${myUserId}`);
                    const score = await res.json();
                    document.getElementById('userPoint').innerText = score;
                } catch (e) {
                    document.getElementById('userPoint').innerText = '0';
                }
            });






            document.addEventListener('DOMContentLoaded', async function() {
                const urlParams = new URLSearchParams(window.location.search);
                let scheduleId = urlParams.get('scheduleId');
                const movieId = urlParams.get('movieId');
                const date = urlParams.get('date');
                const time = urlParams.get('time');

                function toBackendDateFormat(dateStr) {
                    if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) return dateStr;
                    const parts = dateStr.split('-');
                    if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
                    return dateStr;
                }

                // Nếu không có scheduleId nhưng có movieId, date, time thì tìm scheduleId phù hợp
                if (!scheduleId && movieId && date && time) {
                    try {
                        const backendDate = toBackendDateFormat(date);
                        const res = await fetch(`https://localhost:7092/api/GetMovieSchedule?movieId=${movieId}&date=${backendDate}`);
                        let schedules = await res.json();
                        if (schedules.$values) schedules = schedules.$values;
                        if (schedules.data) schedules = schedules.data;
                        if (!Array.isArray(schedules)) return;
                        const found = schedules.find(s => s.fromTime === time || s.toTime === time);
                        if (found) scheduleId = found.id;
                    } catch (e) { return; }
                }
                if (!scheduleId) return;

                // 1. Lấy thông tin suất chiếu (Schedule)
                let schedule = {};
                try {
                    const res = await fetch(`https://localhost:7092/api/schedule/get-by-id/${scheduleId}`);
                    schedule = await res.json();
                } catch (e) { return; }
                if (!schedule || !schedule.movieId || !schedule.cinemaRoomId) return;

                // 2. Lấy thông tin phòng chiếu (CinemaRoom)
                let room = {};
                try {
                    const res = await fetch(`https://localhost:7092/api/cinemaroom/${schedule.cinemaRoomId}`);
                    room = await res.json();
                } catch (e) { return; }

                // 3. Lấy thông tin phim (Movie)
                let movie = {};
                try {
                    const res = await fetch(`https://localhost:7214/api/admin/movies/GetById/${schedule.movieId}`);
                    movie = await res.json();
                    if (movie.data) movie = movie.data;
                } catch (e) {}

                // 4. Render lại UI header
                renderBanner(movie, schedule, room);
            });

            function renderBanner(movie, schedule, room) {
                document.getElementById('movieTitle').innerText = movie.name || 'Tên phim';
                document.getElementById('cinemaName').innerText = room.cinemaName || room.cinemaRoomName || 'Rạp chiếu';
                document.getElementById('showDate').innerText = schedule.showDate || 'Ngày chiếu';
                let timeStr = '';
                if (schedule.fromTime && schedule.toTime) {
                    timeStr = `${schedule.fromTime} - ${schedule.toTime}`;
                } else if (schedule.fromTime) {
                    timeStr = schedule.fromTime;
                }
                document.getElementById('showTime').innerText = timeStr || 'Giờ chiếu';
                document.getElementById('roomName').innerText = room.cinemaRoomName || 'Phòng chiếu';
                if (movie.imagePath) {
                    document.getElementById('moviePoster').innerHTML = `<img src="${movie.imagePath}" alt="${movie.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
            }

            function toggleCollapse(id) {
                var content = document.getElementById(id);
                var icon = document.getElementById('icon-' + id);
                var header = icon && icon.parentElement;
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    if(header) header.classList.add('open');
                    if(icon) icon.innerText = '-';
                } else {
                    content.style.display = 'none';
                    if(header) header.classList.remove('open');
                    if(icon) icon.innerText = '+';
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                // ... các code khác ...

                // Lấy danh sách ghế đã chọn từ localStorage
                let selectedSeats = [];
                try {
                    selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
                } catch (e) { selectedSeats = []; }
                // Hiển thị danh sách ghế
                const seatListDiv = document.getElementById('seatList');
                const seatCountSpan = document.getElementById('seatCount');
                if (selectedSeats.length > 0) {
                    seatListDiv.innerHTML = selectedSeats.map(s => `<span class="seat-tag-3d">${s.seatName}</span>`).join(' ');
                    seatCountSpan.innerText = selectedSeats.length;
                } else {
                    seatListDiv.innerHTML = '<span style="color: #888;">Chưa chọn ghế</span>';
                    seatCountSpan.innerText = '0';
                }

                // Lấy tổng tiền từ localStorage
                const totalPrice = localStorage.getItem('selectedSeatsTotal') || 0;
                document.getElementById('totalPrice').innerText = parseInt(totalPrice).toLocaleString('vi-VN');
                // Nếu có giảm giá, cập nhật discount và finalPrice ở đây
                document.getElementById('finalPrice').innerText = parseInt(totalPrice).toLocaleString('vi-VN');
            });

            function goBackToSeatMap() {
                const urlParams = new URLSearchParams(window.location.search);
                const movieId = urlParams.get('movieId') || '';
                const date = urlParams.get('date') || '';
                const time = urlParams.get('time') || '';
                const scheduleId = urlParams.get('scheduleId') || '';
                window.location.href = `/Booking/Booking/SeatMap?movieId=${movieId}&date=${date}&time=${time}&scheduleId=${scheduleId}`;
            }

            // Biến toàn cục để lưu promotionId và giảm giá từ voucher
            let selectedPromotionId = null;
            let voucherDiscountValue = 0;
            let scoreDiscountValue = 0;
            // Hàm cập nhật tổng giảm giá và số tiền cần thanh toán
            function updateTotalDiscountAndFinalPrice() {
                const total = parseInt(document.getElementById('totalPrice').innerText.replace(/\D/g, '')) || 0;
                const totalDiscount = voucherDiscountValue + scoreDiscountValue;
                document.getElementById('discount').innerText = totalDiscount.toLocaleString('vi-VN');
                document.getElementById('finalPrice').innerText = (total - totalDiscount).toLocaleString('vi-VN');
            }
            document.getElementById('checkVoucherBtn').onclick = async function() {
                const code = document.getElementById('voucherInput').value.trim();
                const total = parseInt(document.getElementById('totalPrice').innerText.replace(/\D/g, '')) || 0;
                if (!code) {
                    document.getElementById('voucherResult').innerText = 'Vui lòng nhập mã khuyến mãi!';
                    selectedPromotionId = null;
                    voucherDiscountValue = 0;
                    updateTotalDiscountAndFinalPrice();
                    return;
                }
                try {
                    const res = await fetch('https://localhost:7092/api/Promotion');
                    const promotions = await res.json();
                    let promoList = promotions;
                    if (promotions.$values) promoList = promotions.$values;
                    const found = Array.isArray(promoList) ? promoList.find(p => (p.title || p.Title || '').toLowerCase() === code.toLowerCase()) : null;
                    if (found) {
                        const discountLevel = parseFloat(found.discountLevel || found.DiscountLevel || 0);
                        voucherDiscountValue = Math.floor(total * (discountLevel / 100));
                        document.getElementById('voucherResult').innerText = `Mã hợp lệ! Giảm giá: ${voucherDiscountValue.toLocaleString('vi-VN')} VND`;
                        selectedPromotionId = found.promotionId || found.PromotionId || found.id || null;
                    } else {
                        document.getElementById('voucherResult').innerText = 'Mã khuyến mãi không hợp lệ!';
                        selectedPromotionId = null;
                        voucherDiscountValue = 0;
                    }
                    updateTotalDiscountAndFinalPrice();
                } catch (e) {
                    document.getElementById('voucherResult').innerText = 'Lỗi khi kiểm tra mã khuyến mãi!';
                    selectedPromotionId = null;
                    voucherDiscountValue = 0;
                    updateTotalDiscountAndFinalPrice();
                }
            };

            // Xử lý kiểm tra điểm thưởng
            document.getElementById('pointInput').addEventListener('input', function() {
                document.getElementById('pointCheckResult')?.remove();
            });
            // Thêm nút kiểm tra điểm nếu chưa có
            if (!document.getElementById('checkPointBtn')) {
                const td = document.querySelector('.point-table tr:nth-child(2) td:last-child');
                if (td) {
                    const btn = document.createElement('button');
                    btn.id = 'checkPointBtn';
                    btn.innerText = 'Kiểm tra';
                    btn.style.marginLeft = '0.5rem';
                    btn.className = 'pay-btn';
                    td.appendChild(btn);
                }
            }
            document.getElementById('checkPointBtn').onclick = async function() {
                const input = document.getElementById('pointInput');
                const userPoint = parseInt(document.getElementById('userPoint').innerText.replace(/\D/g, '')) || 0;
                const total = parseInt(document.getElementById('totalPrice').innerText.replace(/\D/g, '')) || 0;
                // Xóa thông báo cũ
                document.getElementById('pointCheckResult')?.remove();
                const result = document.createElement('div');
                result.id = 'pointCheckResult';
                result.style.marginTop = '0.5rem';
                result.style.color = '#d32f2f';
                input.parentElement.appendChild(result);
                const value = parseInt(input.value) || 0;
                // Tính số điểm tối đa có thể dùng theo tổng tiền còn lại sau voucher
                const maxScoreUsable = Math.floor((total - voucherDiscountValue) / 5000);
                if (value > userPoint) {
                    result.innerText = 'Bạn không đủ điểm để dùng!';
                    input.value = userPoint;
                    scoreDiscountValue = 0;
                    updateTotalDiscountAndFinalPrice();
                    return;
                }
                if (value > maxScoreUsable) {
                    result.innerText = `Bạn chỉ có thể dùng tối đa ${maxScoreUsable} điểm cho đơn này!`;
                    input.value = maxScoreUsable;
                    scoreDiscountValue = 0;
                    updateTotalDiscountAndFinalPrice();
                    return;
                }
                // Nếu hợp lệ
                scoreDiscountValue = value * 5000;
                result.style.color = '#388e3c';
                result.innerText = `Bạn được giảm ${scoreDiscountValue.toLocaleString('vi-VN')} VND từ điểm!`;
                updateTotalDiscountAndFinalPrice();
            };

            document.getElementById('payBtn').onclick = async function proceedToPayment() {
                try {
                    // Lấy userId
                    let myUserId = window.realUserId || localStorage.getItem('userId');
                    if (!myUserId) {
                        alert('Bạn cần đăng nhập để thanh toán!');
                        return;
                    }
                    // Lấy scheduleId, seatIds từ localStorage
                    const urlParams = new URLSearchParams(window.location.search);
                    const scheduleId = urlParams.get('scheduleId');
                    let selectedSeats = [];
                    try {
                        selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
                    } catch (e) { selectedSeats = []; }
                    const seatIds = selectedSeats.map(s => s.seatId);
                    if (!scheduleId || seatIds.length === 0) {
                        alert('Thiếu thông tin đặt vé!');
                        return;
                    }
                    // Lấy tổng tiền, giảm giá, điểm sử dụng
                    const totalPrice = parseInt(document.getElementById('totalPrice').innerText.replace(/\D/g, '')) || 0;
                    const discount = parseInt(document.getElementById('discount').innerText.replace(/\D/g, '')) || 0;
                    const finalPrice = parseInt(document.getElementById('finalPrice').innerText.replace(/\D/g, '')) || 0;
                    const addScore = parseInt(document.getElementById('pointInput').value) || 0;
                    // Nếu có mã voucher, có thể lấy id hoặc title nếu cần gửi lên
                    // Show loading state
                    const payBtn = document.getElementById('payBtn');
                    const originalText = payBtn.innerHTML;
                    payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Đang xử lý...</span>';
                    payBtn.disabled = true;
                    // Gọi API booking
                    const bookingPayload = {
                        scheduleId: parseInt(scheduleId),
                        seatIds: seatIds,
                        userId: parseInt(myUserId),
                        totalPrice: totalPrice,
                        addScore: addScore
                    };
                    // Nếu có promotionId thì gửi lên discountId
                    if (selectedPromotionId) {
                        bookingPayload.discountId = selectedPromotionId;
                    }
                    const bookingRes = await fetch('https://localhost:7092/api/Order/booking', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingPayload)
                    });
                    if (!bookingRes.ok) {
                        const err = await bookingRes.text();
                        alert('Tạo order thất bại! ' + err);
                        payBtn.innerHTML = originalText;
                        payBtn.disabled = false;
                        return;
                    }
                    const bookingData = await bookingRes.json();
                    const orderId = bookingData.id || bookingData.data?.id || bookingData.orderId;
                    if (!orderId) {
                        alert('Tạo order thất bại!');
                        payBtn.innerHTML = originalText;
                        payBtn.disabled = false;
                        return;
                    }
                    // Gọi API lấy URL thanh toán VNPAY
                    const vnpayRes = await fetch(`https://localhost:7092/api/Vnpay/create-url?orderId=${orderId}`);
                    const vnpayData = await vnpayRes.json();
                    const paymentUrl = vnpayData.paymentUrl;
                    if (!paymentUrl) {
                        alert('Không lấy được link thanh toán!');
                        payBtn.innerHTML = originalText;
                        payBtn.disabled = false;
                        return;
                    }
                    // Chuyển hướng sang trang thanh toán
                    window.location.href = paymentUrl;
                } catch (e) {
                    alert('Có lỗi khi thanh toán: ' + e);
                    const payBtn = document.getElementById('payBtn');
                    payBtn.innerHTML = 'Thanh toán';
                    payBtn.disabled = false;
                }
            };
        </script>
    }
</body>
</html>
